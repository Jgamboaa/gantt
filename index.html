<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Diagramas de Gantt Simple</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- html2canvas para exportar a imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css" />
    <link rel="stylesheet" href="assets/toastify-helpers.css" />

    <style>
        /* Personalización de la barra de desplazamiento */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .custom-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Estilo para las celdas de la grilla */
        .grid-lines {
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px);
            background-size: 100% 100%;
        }

        /* Sombra de texto (estable al exportar) */
        .gantt-bar-label {
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.35);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans min-h-screen p-3 md:p-6">

    <div class="max-w-6xl mx-auto">

        <!-- Header y Controles Superiores -->
        <header class="mb-5 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
            <div>
                <h1 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                    <i class="ph ph-chart-bar text-indigo-600"></i> Generador Gantt
                </h1>
                <p class="text-slate-500 text-xs mt-0.5">Compacto para presentaciones.</p>
            </div>

            <button id="exportBtn" onclick="exportToPNG()"
                class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded shadow-sm flex items-center gap-2 transition-all font-medium text-xs">
                <i class="ph ph-download-simple text-base"></i> Exportar PNG
            </button>
        </header>

        <!-- Panel de Configuración e Inputs -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-5">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">

                <!-- Configuración Global -->
                <div class="md:col-span-3 space-y-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Nombre
                            del Proyecto</label>
                        <input type="text" id="projectName" placeholder="Ej: Rediseño Web"
                            class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-xs rounded focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Duración
                            (Semanas)</label>
                        <input type="number" id="totalWeeks" value="12" min="1" max="52" onchange="updateGrid()"
                            class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-xs rounded focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
                    </div>
                </div>

                <!-- Formulario Nueva Tarea -->
                <div
                    class="md:col-span-9 bg-slate-50 p-3 rounded border border-slate-100 h-full flex flex-col justify-center">
                    <h3 class="text-xs font-bold text-slate-700 mb-2 flex items-center gap-1">
                        <i class="ph ph-plus-circle"></i> Nueva Tarea
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                        <div class="md:col-span-5">
                            <label class="block text-[10px] font-medium text-slate-500 mb-0.5">Descripción</label>
                            <input type="text" id="taskName" placeholder="Descripción..."
                                class="w-full bg-white border border-slate-300 rounded p-1.5 text-xs focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-medium text-slate-500 mb-0.5">Inicio</label>
                            <input type="number" id="startWeek" min="1" value="1"
                                class="w-full bg-white border border-slate-300 rounded p-1.5 text-xs focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-medium text-slate-500 mb-0.5">Fin</label>
                            <input type="number" id="endWeek" min="1" value="3"
                                class="w-full bg-white border border-slate-300 rounded p-1.5 text-xs focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-3 flex items-end gap-2">
                            <button id="saveTaskBtn" onclick="saveTask()"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded text-xs px-3 py-1.5 text-center transition-colors">
                                Agregar
                            </button>
                            <button id="cancelEditBtn" onclick="cancelEdit()" type="button"
                                class="hidden w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded text-xs px-3 py-1.5 text-center transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Visualización (Lo que se exportará) -->
        <div class="bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden relative">

            <!-- Contenedor capturable -->
            <div id="gantt-container" class="p-5 bg-white w-full overflow-x-auto custom-scroll relative">

                <!-- Título del Proyecto (Visible solo al exportar o si se desea) -->
                <div id="project-title-display" class="mb-4 hidden">
                    <h2 class="text-xl font-bold text-slate-800 tracking-tight">Cronograma del Proyecto</h2>
                </div>

                <div class="min-w-[600px]"> <!-- Ancho mínimo reducido -->

                    <!-- Cabecera de la Grilla -->
                    <div id="gantt-header"
                        class="grid border-b border-slate-200 pb-2 mb-1 font-semibold text-slate-600 text-[10px] items-center">
                        <!-- Se llena con JS -->
                    </div>

                    <!-- Cuerpo de la Grilla (Tareas) -->
                    <div id="gantt-body" class="space-y-1 relative pt-1">
                        <!-- Las tareas se inyectan aquí -->
                        <div class="absolute inset-0 grid-lines z-0 pointer-events-none opacity-50 -mt-1"
                            id="grid-background"></div>
                    </div>

                </div>
            </div>

        </div>

        <!-- Lista de tareas para borrar (UI only) -->
        <div class="mt-6">
            <h3 class="text-sm font-semibold text-slate-700 mb-3">Gestión de Tareas</h3>
            <div id="task-list-ui" class="space-y-1.5">
                <!-- Lista simple para borrar elementos -->
                <p class="text-slate-400 text-xs italic">No hay tareas creadas.</p>
            </div>
        </div>

    </div>

    <script src="assets/toastify-helpers.js"></script>
    <script>
        // --- Estado de la Aplicación ---
        let tasks = [
            { id: 1, name: "Planificación", start: 1, end: 2, color: "bg-blue-500" },
            { id: 2, name: "Desarrollo", start: 3, end: 6, color: "bg-indigo-500" },
            { id: 3, name: "Integración", start: 5, end: 8, color: "bg-violet-500" }
        ];
        let editingTaskId = null;

        // Colores para rotar
        const colors = [
            "bg-blue-500", "bg-indigo-500", "bg-violet-500", "bg-purple-500",
            "bg-fuchsia-500", "bg-pink-500", "bg-rose-500", "bg-orange-500",
            "bg-amber-500", "bg-emerald-500", "bg-teal-500", "bg-cyan-500"
        ];

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            renderGantt();
            renderTaskList();
        });

        // --- Funciones Principales ---

        function updateGrid() {
            renderGantt();
        }

        function saveTask() {
            const name = document.getElementById('taskName').value.trim();
            const start = parseInt(document.getElementById('startWeek').value);
            const end = parseInt(document.getElementById('endWeek').value);
            const totalWeeks = parseInt(document.getElementById('totalWeeks').value);

            // Validaciones
            if (!name) return ToastifyUtils.warning("Por favor escribe una descripción.");
            if (start > end) return ToastifyUtils.error("Inicio no puede ser posterior a fin.");
            if (start < 1) return ToastifyUtils.warning("Inicio debe ser al menos 1.");
            if (end > totalWeeks) return ToastifyUtils.error(`Fin excede duración (${totalWeeks}).`);

            if (editingTaskId !== null) {
                const task = tasks.find(t => t.id === editingTaskId);
                if (task) {
                    task.name = name;
                    task.start = start;
                    task.end = end;
                } else {
                    tasks.push({
                        id: Date.now(),
                        name: name,
                        start: start,
                        end: end,
                        color: colors[tasks.length % colors.length]
                    });
                }
            } else {
                tasks.push({
                    id: Date.now(),
                    name: name,
                    start: start,
                    end: end,
                    color: colors[tasks.length % colors.length]
                });
            }

            // Limpiar inputs
            resetTaskForm(end, totalWeeks);

            renderGantt();
            renderTaskList();
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            if (editingTaskId === id) {
                resetTaskForm();
            }
            renderGantt();
            renderTaskList();
        }

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            editingTaskId = id;
            document.getElementById('taskName').value = task.name;
            document.getElementById('startWeek').value = task.start;
            document.getElementById('endWeek').value = task.end;
            document.getElementById('saveTaskBtn').textContent = 'Actualizar';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        }

        function cancelEdit() {
            resetTaskForm();
        }

        function resetTaskForm(lastEnd = null, totalWeeksOverride = null) {
            const totalWeeks = totalWeeksOverride ?? parseInt(document.getElementById('totalWeeks').value);
            document.getElementById('taskName').value = '';
            if (lastEnd !== null) {
                document.getElementById('startWeek').value = lastEnd + 1 <= totalWeeks ? lastEnd + 1 : totalWeeks;
                document.getElementById('endWeek').value = lastEnd + 2 <= totalWeeks ? lastEnd + 2 : totalWeeks;
            }
            editingTaskId = null;
            document.getElementById('saveTaskBtn').textContent = 'Agregar';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        function renderGantt() {
            const totalWeeks = parseInt(document.getElementById('totalWeeks').value);
            const headerContainer = document.getElementById('gantt-header');
            const bodyContainer = document.getElementById('gantt-body');
            const gridBackground = document.getElementById('grid-background');

            // 1. Configurar Estructura de Grilla Compacta
            // Reducido ancho nombre a 200px
            const gridTemplate = `200px repeat(${totalWeeks}, minmax(30px, 1fr))`;

            // 2. Renderizar Cabecera
            let headerHTML = `<div class="pl-2 uppercase tracking-wider text-[10px]">Actividad</div>`;
            for (let i = 1; i <= totalWeeks; i++) {
                headerHTML += `<div class="text-center text-[10px] text-slate-500">S${i}</div>`;
            }

            headerContainer.style.gridTemplateColumns = gridTemplate;
            headerContainer.innerHTML = headerHTML;

            // Configurar fondo
            gridBackground.style.gridTemplateColumns = gridTemplate;
            let bgHTML = `<div></div>`;
            for (let i = 0; i < totalWeeks; i++) {
                bgHTML += `<div class="border-l border-slate-100 h-full"></div>`;
            }
            gridBackground.innerHTML = bgHTML;


            // 3. Renderizar Tareas
            const existingTasks = Array.from(bodyContainer.children).filter(child => !child.id.includes('grid-background'));
            existingTasks.forEach(el => el.remove());

            tasks.forEach(task => {
                const row = document.createElement('div');
                // Altura de fila reducida
                row.className = "grid items-center relative z-10 hover:bg-slate-50 transition-colors rounded min-h-[28px]";
                row.style.gridTemplateColumns = gridTemplate;

                // Columna Nombre (texto más pequeño)
                const nameCell = document.createElement('div');
                nameCell.className = "font-medium text-xs text-slate-700 pr-4 pl-2 leading-tight py-1 flex items-center";
                nameCell.textContent = task.name;
                row.appendChild(nameCell);

                // Barra Gantt
                const barCell = document.createElement('div');
                barCell.style.gridColumnStart = task.start + 1;
                barCell.style.gridColumnEnd = task.end + 2;

                // Barra reducida: h-6 (24px)
                barCell.className = `gantt-bar h-6 rounded shadow-sm flex items-center justify-center text-[10px] text-white font-medium ${task.color} bg-opacity-90 border border-white/20 mx-0.5 relative`;
                barCell.innerHTML = `<span class="gantt-bar-label px-1 w-full h-full flex items-center justify-center whitespace-nowrap overflow-hidden z-10">${task.end - task.start + 1}s</span>`;

                barCell.title = `${task.name}: S${task.start}-S${task.end}`;

                row.appendChild(barCell);
                bodyContainer.appendChild(row);
            });
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-ui');
            if (tasks.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-xs italic">No hay tareas creadas.</p>';
                return;
            }

            let html = '';
            tasks.forEach(task => {
                html += `
                    <div class="flex items-center justify-between bg-white border border-slate-200 p-2 rounded hover:shadow-sm transition-shadow">
                        <div class="flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-full ${task.color}"></div>
                            <div>
                                <p class="text-xs font-bold text-slate-700">${task.name}</p>
                                <p class="text-[10px] text-slate-500">Sem ${task.start} - ${task.end}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="editTask(${task.id})" class="text-slate-400 hover:text-indigo-600 p-1 transition-colors" title="Editar">
                                <i class="ph ph-pencil-simple text-base"></i>
                            </button>
                            <button onclick="deleteTask(${task.id})" class="text-slate-400 hover:text-red-500 p-1 transition-colors" title="Eliminar">
                                <i class="ph ph-trash text-base"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- Exportación a Imagen ---
        async function exportToPNG() {
            const element = document.getElementById('gantt-container');
            const exportBtn = document.getElementById('exportBtn');

            const projectNameInput = document.getElementById('projectName').value.trim();
            const titleContainer = document.getElementById('project-title-display');
            const titleElement = titleContainer.querySelector('h2');

            titleElement.textContent = projectNameInput || "Cronograma";

            titleContainer.classList.remove('hidden');

            const prevBtnHTML = exportBtn?.innerHTML;
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.classList.add('opacity-60', 'cursor-not-allowed');
                exportBtn.innerHTML = `<i class="ph ph-circle-notch text-base animate-spin"></i> Generando...`;
            }

            try {
                // Evita capturar antes de que las fuentes estén listas
                if (document.fonts && document.fonts.ready) {
                    try { await document.fonts.ready; } catch { /* ignore */ }
                }

                const canvas = await html2canvas(element, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    onclone: (clonedDoc) => {
                        const clonedElement = clonedDoc.getElementById('gantt-container');
                        if (!clonedElement) return;

                        clonedElement.style.overflow = 'visible';
                        clonedElement.style.width = 'fit-content';
                        clonedElement.style.height = 'auto';
                        clonedElement.style.padding = '20px';

                        // Texto de tareas (columna izquierda)
                        const textCells = clonedElement.querySelectorAll('.font-medium.text-xs');
                        textCells.forEach(cell => {
                            cell.style.overflow = 'visible';
                            cell.style.whiteSpace = 'normal';
                            cell.style.height = 'auto';
                            cell.style.minHeight = '24px';
                            cell.style.display = 'flex';
                            cell.style.alignItems = 'center';
                            cell.style.lineHeight = '1.2';
                        });

                        // Barras
                        const bars = clonedElement.querySelectorAll('.gantt-bar');
                        bars.forEach(bar => {
                            bar.style.display = 'flex';
                            bar.style.alignItems = 'center';
                            bar.style.justifyContent = 'center';
                            bar.style.lineHeight = 'normal';
                            bar.style.position = 'relative';
                        });

                        // Texto dentro de las barras - centrado estable para html2canvas
                        const barLabels = clonedElement.querySelectorAll('.gantt-bar-label');
                        barLabels.forEach(span => {
                            span.style.overflow = 'visible';
                            span.style.whiteSpace = 'nowrap';
                            span.style.display = 'block';
                            span.style.position = 'absolute';
                            span.style.left = '50%';
                            span.style.top = '50%';
                            span.style.transform = 'translate(-50%, -50%)';
                            span.style.width = 'auto';
                            span.style.height = 'auto';
                            span.style.lineHeight = '1';
                            span.style.textShadow = '0 1px 1px rgba(0,0,0,0.35)';
                        });
                    }
                });

                const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));

                if (!blob) {
                    throw new Error('No se pudo generar el PNG.');
                }

                const safeName = (projectNameInput || 'gantt').replace(/[^a-z0-9]/gi, '-').toLowerCase();

                const link = document.createElement('a');
                link.download = `${safeName}.png`;
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.click();
                setTimeout(() => URL.revokeObjectURL(url), 1000);

            } catch (err) {
                console.error("Error al exportar:", err);
                ToastifyUtils.error("Hubo un error al generar la imagen.");
            } finally {
                titleContainer.classList.add('hidden');
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                    exportBtn.innerHTML = prevBtnHTML || `<i class="ph ph-download-simple text-base"></i> Exportar PNG`;
                }
            }
        }
    </script>
</body>

</html>